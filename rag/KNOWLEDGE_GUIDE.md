# 门店/企业知识构建与微调教程（RAG）

面向希望将“门店知识（商品、促销、FAQ、话术）”注入 Ani 的研发/运营同学。本指南帮助你：
- 规划知识目录与字段规范
- 将原始资料清洗为标准 JSON/CSV 并放入 `rag/data/`
- 用内置检索器快速验收召回质量，按需微调
- 为后续向量检索与模板化回答做好演进准备

---

## 1. 目录结构与职责

```
rag/
├─ data/           # 放置标准化后的知识数据（JSON/CSV）
├─ index/          # 预留向量索引/缓存目录（后续演进）
├─ knowledge.py    # 轻量检索器（零依赖，EN 词元 + 中文双字词）
├─ README.md       # 简要说明
└─ KNOWLEDGE_GUIDE.md  # 本教程
```

> 现阶段使用词法检索（简洁、零依赖）；未来可按本指南“升级路线”接入 FAISS/Chroma 等向量库。

---

## 2. 数据模型与字段规范（JSON/CSV）

推荐使用 JSON 数组（首选）或 CSV（表格导出方便）。统一字段：

- `id`（可选）：唯一标识。未提供时会自动生成
- `title`（必填）：标题/问题/品名（简短）
- `text`（必填）：正文/答案/卖点描述（可多句）
- `tags`（可选）：标签数组，如 `["饮品", "促销", "夏季"]`
- `meta`（可选）：自由扩展，如 `{ "store_id": "001", "valid_from": "2025-06-01", "valid_to": "2025-06-30", "price": 19.9 }`

示例（JSON）：

```json
[
  {
    "id": "faq-001",
    "title": "优惠券如何领取",
    "text": "到店扫码关注后即可领取 5 元优惠券，部分商品不参与。",
    "tags": ["FAQ", "优惠券"],
    "meta": { "channel": "wechat", "store_id": "*" }
  },
  {
    "id": "sku-1001",
    "title": "夏季新品清凉饮品",
    "text": "限时第二杯半价；口味包含柠檬、蜜桃、百香果。",
    "tags": ["饮品", "促销", "夏季"],
    "meta": { "store_id": "001", "price": 18.0 }
  }
]
```

示例（CSV）：

```csv
id,title,text,tags,meta
faq-001,优惠券如何领取,到店扫码关注后即可领取5元优惠券，部分商品不参与。,FAQ|优惠券,{"channel":"wechat","store_id":"*"}
sku-1001,夏季新品清凉饮品,限时第二杯半价；口味包含柠檬、蜜桃、百香果。,饮品|促销|夏季,{"store_id":"001","price":18.0}
```

字段建议：
- 价格/时效类信息放入 `meta` 并标明 `valid_from/valid_to`，便于未来做时效过滤
- 跨店共享用 `store_id:"*"`，门店专属写具体门店号
- 多语言可在同条 `meta.lang` 上标记或为不同语言保留多条记录

---

## 3. 数据治理流程（从原始资料到上线）

1) 收集资料：价签表、促销海报文案、FAQ 文档、员工话术模板等

2) 清洗/规范：
- 统一标点与数字格式，去除重复/过期信息
- 每条只表达一个主题（便于检索切分）
- 标注 `tags` 与关键 `meta`（价格、时效、门店）

3) 导出与落盘：
- 推荐导出 JSON 数组；或 CSV（用 `|` 分隔的标签）
- 文件命名：`products.json`、`promotions_2025Q2.json`、`faq.csv` 等
- 放入 `rag/data/` 目录

4) 验收与回归：
- 启动服务后日志会输出 `[RAG] Loaded N records`；若失败会有错误行
- 使用下面“快速检索测试”手动测若干关键问题

5) 发布与变更：
- 用 Git 管理数据文件，PR 审核 + CHANGELOG 记录
- 下线过期文件或在 `meta.valid_to` 过期后清理

---

## 4. 快速检索测试（代码）

```python
from rag.knowledge import KnowledgeBase

kb = KnowledgeBase()  # 默认读取 rag/data
for q in ["优惠券", "第二杯半价", "午市套餐时间"]:
    hits = kb.search(q, top_k=3)
    print("\nQ:", q)
    for h in hits:
        print(h["score"], h["title"], "|", h["snippet"])  # 分数、标题、片段
```

调优建议：
- 召回差：为关键问法补齐同义词（如 “折扣/打折/优惠/特价/满减”）并写入 `text`
- 噪声多：将冗长文案拆成多条记录，每条只保留显著要点
- top_k：一般 3–5 即可，再多反而干扰

---

## 5. 模板化回答（命中优先）

为降低跑题与幻觉，推荐“命中→模板化→润色”的两段式：

1) 检索 `kb.search(query)`，拿到最高分的要点（可汇总多条）
2) 根据模板生成结构化信息：
   - 核心要点：价格/时间/规则/领取方式
   - 风险提示：适用范围、不可叠加等
   - 转化引导：扫码、取号、到某柜台咨询
3) 将上面的要点作为上下文喂给 LLM（Ani），让其“用口语化中文，1–2 句”润色输出即可

范例模板（促销问答）：

```
【要点】：{促销名称/范围/时间/限制}
【引导】：{下一步动作/扫码/去柜台/关注}
【提醒】：{不可叠加/品类限制}
```

---

## 6. 多门店/多品牌组织策略

- 全局知识：`meta.store_id="*"`
- 门店覆盖：同 `title` 下，门店专属记录优先；合并时按 `store_id` 精确匹配 > `*`
- 品牌/频道：用 `tags` 或 `meta.brand / meta.channel` 区分，便于检索过滤

> 未来可在检索层加入过滤器：`store_id=001`、`brand=A`、`now between valid_from/to`。

---

## 7. 质量与合规

- 敏感信息不要入库；如必须（售后电话等），统一口径并标明责任人
- 营销合法合规：标明有效期/限制条件，避免误导
- 数据寿命：设置 `valid_to` 并安排清理任务，避免“过期信息还在答复”

---

## 8. 与系统集成（llm_pipeline 提示词注入）

当前已在 `llm_pipeline.py` 中默认集成：
- 对用户问题检索 top_k（默认 3）
- 注入到提示词的“门店知识候选”区块
- 模型被明确要求“中文口语化，1–2 句，先回应再自然追问”，同时保留 JSON 输出

你可以：
- 将更高分的命中转为“模板化要点”，在喂给模型前先做结构化，再由模型润色
- 按场景调节 `top_k` 与阈值，减少噪声

---

## 9. 升级路线（向量检索/混合 RAG）

- 轻量 → 向量：用 `sentence-transformers`（中文模型）离线生成嵌入，落入 `rag/index/`；用 FAISS/Chroma 做 ANN 检索
- 混合检索：先词法过滤（快速缩小候选），再向量重排（精度更高）
- 质量评估：构造 50–100 条真实问题集，统计 Top‑k 命中率与 MRR，持续改进

> 向量库接入时保持 `KnowledgeBase.search()` 的调用不变（对外接口兼容），仅替换内部实现。

---

## 10. 常见问题（FAQ）

Q: 需要把大段营销文案全量放进 `text` 吗？

A: 不建议。应拆成多条简短记录，每条一个关键点。检索更准、答案更短。

Q: 多语言怎么做？

A: 可以为每条记录添加 `meta.lang`（如 `zh-CN`/`en-US`），或按语言复制一条记录。

Q: 数据异常如何排查？

A: 启动日志里有 `[RAG] Failed to read ...`；逐个修正格式。也可临时 `print(kb.search("关键词"))` 做快速验证。

---

## 11. 变更管理建议

- 所有数据变更走 PR + 代码评审；合并前跑一遍“关键问法清单”
- 维护 `CHANGELOG.md` 与数据文件头部注释（版本/日期/责任人）
- 为运营配置导出模板，减少手工拼写错误

---

如需我将“模板化要点 → LLM 润色”的闭环加到主流程里，或把向量检索接入为可选项，请在 Issue/需求里说明，我可以按该规范无缝集成。

