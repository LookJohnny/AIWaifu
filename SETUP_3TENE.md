# 🎭 3tene 配置指南 - Ani 项目集成

完整的 3tene 设置步骤，让表情控制和 Lip-sync 完美工作！

---

## 📦 第 1 步：安装 3tene（5 分钟）

### **1.1 解压文件**
你已经下载了 3tene，现在：

1. **找到下载的文件**（通常是 ZIP 格式）
   - 例如：`3teneFREE_v2.x.x.zip`

2. **解压到合适位置**
   - 推荐：`C:\Program Files\3tene\`
   - 或者：`C:\Tools\3tene\`

3. **找到 3tene.exe**
   - 在解压后的文件夹中
   - 应该有 `3tene.exe` 或 `3teneFREE.exe`

### **1.2 首次启动**

1. **右键 3tene.exe → 以管理员身份运行**（首次推荐）

2. **Windows 防火墙提示**：
   - 点击 **"允许访问"**
   - 3tene 需要网络权限接收 VMC 数据

3. **首次启动配置向导**：
   - 语言选择：**English** 或 **日本語**（暂无中文）
   - 点击 "OK" 或 "次へ"（下一步）

4. **等待启动**（10-15 秒）
   - 应该看到 3tene 主界面

---

## 🎨 第 2 步：加载 darkhair.vrm 角色（5 分钟）

### **2.1 加载 VRM 文件**

**在 3tene 主界面：**

1. **找到 "Avatar" 或"アバター" 选项**
   - 通常在顶部菜单或左侧面板

2. **点击 "Load VRM"**（或 "VRM を読み込む"）
   - 打开文件浏览器

3. **导航到你的角色文件**：
   ```
   F:\Ani\character\darkhair.vrm
   ```

4. **点击 "打开" 或 "Open"**

5. **等待加载**（10-30 秒）
   - 进度条显示加载状态
   - **角色应该出现在场景中！**

### **2.2 调整角色视图**

**鼠标控制：**
- **旋转相机**：按住右键拖动
- **缩放**：鼠标滚轮
- **平移**：按住中键拖动

**调整到合适位置：**
- 角色头部和上半身清晰可见
- 居中显示
- 适当的缩放比例

---

## ⚙️ 第 3 步：配置 VMC Receiver（关键！10 分钟）

### **3.1 打开设置**

1. **点击 "Settings" 或"設定"**（齿轮图标）
   - 通常在右上角或菜单栏

2. **找到 "VMC Protocol" 或"VMC プロトコル" 选项**
   - 可能在 "Network" 或"ネットワーク" 分类下

### **3.2 启用 VMC Receiver**

**关键设置：**

1. **✅ 勾选 "Enable VMC Receiver"**
   - 或 "VMC 受信を有効にする"
   - **这是最重要的设置！**

2. **端口设置：**
   - Port (ポート): **39539**
   - 保持默认即可

3. **IP 地址：**
   - 应该显示 `127.0.0.1` 或 `localhost`
   - 不需要修改

4. **协议选择：**
   - Protocol: **OSC/UDP**（默认）

### **3.3 表情控制设置**

**在 VMC 设置中或 Face 设置中：**

1. **✅ 勾选 "Apply Expressions"**
   - 或 "表情を適用"
   - 允许外部控制表情

2. **✅ 勾选 "Blend Shape Control"**
   - 或 "ブレンドシェイプ制御"
   - 启用 blend shape 接收

3. **表情强度：**
   - Expression Intensity: `1.0` （100%）
   - 或根据喜好调节（0.5-1.0）

### **3.4 保存设置**

- **点击 "Apply" 或"適用"**
- **点击 "OK" 或"OK"**
- **设置已保存！**

---

## 🎤 第 4 步：配置 Lip-sync（10 分钟）

### **4.1 音频设置**

1. **打开 Settings → Audio** 或 **"設定 → オーディオ"**

2. **音频输入设置：**
   - **Audio Input Device**: 选择 **"Desktop Audio"** 或 **"系统音频"**
   - 这样可以检测 TTS 播放的声音

3. **✅ 启用 Lip Sync**
   - 勾选 "Enable Lip Sync" 或 "リップシンクを有効にする"

### **4.2 Lip-sync 灵敏度**

**调整参数：**

1. **Lip Sync Sensitivity（灵敏度）：**
   - 推荐值：**0.8 - 1.2**
   - 太低：嘴巴动作不明显
   - 太高：嘴巴过度张开

2. **Threshold（阈值）：**
   - 推荐值：**0.01 - 0.05**
   - 过滤低音量噪音

3. **Smoothness（平滑度）：**
   - 推荐值：**0.5**
   - 让嘴巴动作更自然

### **4.3 测试 Lip-sync**

**快速测试：**

1. **播放音乐或说话**
   - 电脑播放任何音频
   - 或对着麦克风说话

2. **观察角色嘴巴**
   - 应该随声音开合
   - 调整灵敏度直到满意

---

## 🎯 第 5 步：优化显示设置（5 分钟）

### **5.1 渲染质量**

**Settings → Graphics** 或 **"設定 → グラフィックス"**

1. **Quality（画质）：**
   - 选择 **"High"** 或 **"最高"**
   - 你的 RTX 4060 完全够用

2. **Anti-aliasing（抗锯齿）：**
   - 推荐：**4x** 或 **8x**
   - 让角色边缘更平滑

3. **Frame Rate（帧率）：**
   - 设置为 **60 FPS**
   - VSync: **ON**（防止撕裂）

### **5.2 背景设置**

**为了方便 OBS 捕捉：**

1. **Background（背景）：**
   - 选择 **"Green Screen"**（绿幕）
   - 或 **"Transparent"**（透明）
   - 便于 OBS chroma key

2. **Lighting（光照）：**
   - 调整到角色清晰可见
   - 不要过暗或过亮

---

## 🧪 第 6 步：测试 VMC 连接（5 分钟）

### **6.1 确认 3tene 准备就绪**

**检查清单：**
- ✅ darkhair.vrm 已加载并显示
- ✅ VMC Receiver 已启用（端口 39539）
- ✅ "Apply Expressions" 已勾选
- ✅ Lip-sync 已启用
- ✅ 设置已保存

**保持 3tene 窗口打开！不要关闭！**

### **6.2 运行测试脚本**

**在 PowerShell 或 CMD 中：**

```bash
cd F:\Ani
python test_vmc.py
```

**观察 3tene 窗口：**
- 角色表情应该快速变化！
- 每个 blend shape 测试持续 1.5 秒
- 你应该看到嘴巴、眉毛、眼睛的变化

**如果有变化 → 成功！✅**
**如果没变化 → 检查 VMC receiver 设置**

---

## 🎭 第 7 步：测试完整表情控制（5 分钟）

### **7.1 运行表情测试**

```bash
cd F:\Ani
python animation_controller.py
```

**预期结果：**
```
Testing: joy (intensity: 1.0)      ← 角色应该微笑
Testing: sad (intensity: 0.8)      ← 角色应该悲伤
Testing: anger (intensity: 0.9)    ← 角色应该愤怒
Testing: surprise (intensity: 1.0) ← 角色应该惊讶
Testing: neutral (intensity: 0.5)  ← 角色回到中性
```

**观察 3tene：**
- ✅ 表情应该清晰变化
- ✅ 每个表情持续 2 秒
- ✅ 平滑过渡

### **7.2 如果表情不变**

**可能原因：**

1. **Blend shape 名称不匹配**
   - 3tene 可能使用不同的名称
   - 需要查看 3tene 的 blend shape 列表

2. **VMC Receiver 未启用**
   - 重新检查设置
   - 确认端口 39539 正确

3. **防火墙阻止**
   - Windows 防火墙可能阻止 UDP
   - 允许 3tene 访问网络

**调试方法：**

在 3tene 中：
1. **Settings → Face** 或 **"設定 → 表情"**
2. **查看 Blend Shape 列表**
3. **手动拖动滑块测试**
4. **记下实际的名称**
5. **告诉我，我来更新代码**

---

## 🗣️ 第 8 步：测试完整对话（10 分钟）

### **8.1 启动后端服务器**

**确认服务器在运行：**
- 应该已经在后台运行（df9aa6）
- 访问 http://localhost:8000 验证

**如果没有运行：**
```bash
cd F:\Ani
python main_full.py
```

### **8.2 进行对话测试**

**测试步骤：**

1. **打开浏览器** → http://localhost:8000

2. **点击 "Start Listening"**

3. **测试不同情绪的对话：**

   **测试 1 - Joy（开心）：**
   - 你说："告诉我一个好消息"
   - 观察：角色应该微笑 + 嘴巴同步

   **测试 2 - Sad（悲伤）：**
   - 你说："讲一个悲伤的故事"
   - 观察：角色应该悲伤表情 + 嘴巴同步

   **测试 3 - Anger（愤怒）：**
   - 你说："什么让人生气？"
   - 观察：角色应该愤怒表情 + 嘴巴同步

   **测试 4 - Surprise（惊讶）：**
   - 你说："给我一个惊喜"
   - 观察：角色应该惊讶表情 + 嘴巴同步

   **测试 5 - Neutral（中性）：**
   - 你说："2 加 2 等于几？"
   - 观察：角色保持中性 + 嘴巴同步

### **8.3 成功标准**

**✅ 完美运行应该看到：**
1. 🗣️ 你说话 → 系统识别
2. 🧠 AI 思考 → 生成回复
3. 😊 **角色表情变化**（根据情绪）
4. 👄 **角色嘴巴动**（同步 TTS 音频）
5. 🔊 听到语音回复
6. 😌 角色回到中性状态

---

## 📺 第 9 步：OBS 集成（可选，15 分钟）

### **9.1 在 OBS 中添加 3tene**

1. **启动 OBS Studio**

2. **创建新场景**：
   - 场景名称："Ani - 3tene"

3. **添加窗口捕获**：
   - Sources → "+" → "Window Capture"
   - 名称："3tene Character"
   - Window: 选择 3tene 窗口
   - Capture method: Windows 10/11

4. **如果使用绿幕背景**：
   - 右键 "3tene Character" → Filters
   - 添加 "Chroma Key"
   - Key Color: Green
   - 调整 Similarity 和 Smoothness

5. **全屏到电视**：
   - 右键场景 → Fullscreen Projector
   - 选择你的电视显示器

---

## 🐛 常见问题排查

### **问题 1：角色加载失败**

**症状**：3tene 显示错误，无法加载 darkhair.vrm

**解决方案**：
1. 确认 VRM 文件完整（16MB）
2. 尝试重新导出 VRM（如果有 VRoid 项目）
3. 检查 3tene 版本是否支持 VRM 0.0

---

### **问题 2：VMC 连接失败**

**症状**：测试脚本运行，但角色无反应

**解决方案**：
1. **确认端口**：3tene 设置中是 39539
2. **检查防火墙**：允许 3tene 和 Python
3. **重启 3tene**：关闭后重新打开
4. **检查 "Apply Expressions"**：必须勾选

**测试连接：**
```bash
netstat -an | findstr 39539
```
应该显示 UDP 端口在监听。

---

### **问题 3：表情不变化**

**症状**：VMC 连接成功，但表情不变

**可能原因 + 解决方案**：

1. **Blend shape 名称不匹配**
   - 在 3tene 中查看实际的 blend shape 名称
   - 更新 animation_controller.py

2. **表情强度太低**
   - 在 3tene 设置中增加 Expression Intensity

3. **角色不支持某些表情**
   - darkhair.vrm 可能没有所有 blend shapes
   - 使用角色支持的表情

---

### **问题 4：Lip-sync 不工作**

**症状**：音频播放，但嘴巴不动

**解决方案**：

1. **检查音频输入源**：
   - 3tene 设置 → Audio → Input Device
   - 改为 "Desktop Audio" 或 "系统音频"

2. **调整灵敏度**：
   - Lip Sync Sensitivity: 增加到 1.2-1.5
   - Threshold: 降低到 0.01

3. **测试系统音频**：
   - 播放音乐看嘴巴是否动
   - 如果动 → 说明 Lip-sync 工作
   - 如果不动 → 检查音频设备

---

### **问题 5：性能问题/卡顿**

**症状**：3tene 运行缓慢，FPS 低

**解决方案**：

1. **降低画质**：
   - Graphics → Quality: Medium
   - Anti-aliasing: 2x

2. **检查 GPU 使用**：
   - 任务管理器 → 性能 → GPU
   - 应该看到 3tene 使用 GPU

3. **关闭其他程序**：
   - 释放 GPU 和 RAM

---

## ✅ 配置完成检查清单

**在继续测试前，确认：**

- ✅ 3tene 已安装并运行
- ✅ darkhair.vrm 已加载并显示
- ✅ VMC Receiver 已启用（端口 39539）
- ✅ "Apply Expressions" 已勾选
- ✅ Lip-sync 已启用（音频输入：Desktop Audio）
- ✅ test_vmc.py 运行时有反应
- ✅ 背景服务器在运行（http://localhost:8000）

**如果全部 ✅ → 准备进行完整测试！**

---

## 🎉 成功后的效果

**你将拥有：**
- 🎭 **AI 情绪驱动的表情变化**
- 👄 **完美的 Lip-sync**（中文 + 英文）
- 🗣️ **自然的对话流程**
- 📺 **专业的电视显示**
- ✨ **完整的多模态 AI 伴侣体验**

---

## 📞 需要帮助？

**遇到问题时：**
1. 截图错误信息
2. 告诉我具体哪一步卡住了
3. 描述看到的现象
4. 我会帮你调试！

---

**准备好了就告诉我 "3tene 配置完成"，然后我们开始测试！** 🚀
